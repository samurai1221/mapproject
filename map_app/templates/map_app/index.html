{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>–ö–∞—Ä—Ç–∞ —Å –º–æ–∏–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º</title>
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="#1976d2">
    <link rel="icon" href="{% static 'icons/icon-192x192.png' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100vh;
        width: 100%;
      }
      #locate-btn {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 5;
        background: white;
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }
      #locate-btn:hover {
        background: #f1f1f1;
      }
    </style>
  </head>
  <body>
    <button id="locate-btn">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
    <div id="map"></div>

    <script>
      let map;
      let userMarker;

      function initMap() {
        const center = { lat: 43.238949, lng: 76.889709 }; // –ê–ª–º–∞—Ç—ã
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 12,
          center: center,
        });

        const marker = new google.maps.Marker({
          position: center,
          map: map,
          title: "–ê–ª–º–∞—Ç—ã",
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"
        document.getElementById("locate-btn").addEventListener("click", () => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const userPos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                };

                if (userMarker) {
                  userMarker.setMap(null);
                }

                userMarker = new google.maps.Marker({
                  position: userPos,
                  map: map,
                  title: "–í—ã –∑–¥–µ—Å—å",
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: "#4285F4",
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: "#ffffff",
                  },
                });

                map.setCenter(userPos);
                map.setZoom(14);
              },
              () => {
                alert("‚ö†Ô∏è –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.");
              }
            );
          } else {
            alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.");
          }
        });
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap"
      async defer>
    </script>
    <script>
  let deferredPrompt;

  window.addEventListener('beforeinstallprompt', (e) => {
    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ
    e.preventDefault();
    deferredPrompt = e;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ—é –∫–Ω–æ–ø–∫—É / —Å–æ–æ–±—â–µ–Ω–∏–µ
    const installBanner = document.createElement('div');
    installBanner.innerHTML = `
      <div style="
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #317EFB;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        font-family: sans-serif;
        z-index: 1000;
      ">
        <span>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω?</span>
        <button id="install-btn" style="
          background: white;
          color: #317EFB;
          border: none;
          margin-left: 10px;
          padding: 6px 12px;
          border-radius: 6px;
          cursor: pointer;
          font-weight: 600;
        ">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      </div>
    `;
    document.body.appendChild(installBanner);

    const installBtn = document.getElementById('install-btn');
    installBtn.addEventListener('click', async () => {
      installBanner.remove(); // —É–±–∏—Ä–∞–µ–º –±–∞–Ω–Ω–µ—Ä
      deferredPrompt.prompt(); // –≤—ã–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ –æ–∫–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

      const choiceResult = await deferredPrompt.userChoice;
      if (choiceResult.outcome === 'accepted') {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–∏–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');
      } else {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª —É—Å—Ç–∞–Ω–æ–≤–∫—É');
      }
      deferredPrompt = null;
    });
  });
</script>

  </body>
</html>
