{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>–ö–∞—Ä—Ç–∞ —Å –º–æ–∏–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º</title>
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="#1976d2">
    <link rel="icon" href="{% static 'icons/icon-192x192.png' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100vh;
        width: 100%;
      }
      #locate-btn {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 5;
        background: white;
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }
      #locate-btn:hover {
        background: #f1f1f1;
      }
    </style>
  </head>
  <body>
    <button id="locate-btn">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
    <div id="map"></div>

    <script>
      let map;
      let userMarker;

      function initMap() {
        const center = { lat: 43.238949, lng: 76.889709 }; // –ê–ª–º–∞—Ç—ã
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 12,
          center: center,
        });

        const marker = new google.maps.Marker({
          position: center,
          map: map,
          title: "–ê–ª–º–∞—Ç—ã",
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"
        document.getElementById("locate-btn").addEventListener("click", () => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const userPos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                };

                if (userMarker) {
                  userMarker.setMap(null);
                }

                userMarker = new google.maps.Marker({
                  position: userPos,
                  map: map,
                  title: "–í—ã –∑–¥–µ—Å—å",
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: "#4285F4",
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: "#ffffff",
                  },
                });

                map.setCenter(userPos);
                map.setZoom(14);
              },
              () => {
                alert("‚ö†Ô∏è –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.");
              }
            );
          } else {
            alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.");
          }
        });
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap"
      async defer>
    </script>
    <script>
  let deferredPrompt;

  // –°–æ–±—ã—Ç–∏–µ, –∫–æ–≥–¥–∞ –±—Ä–∞—É–∑–µ—Ä –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ PWA –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
  window.addEventListener('beforeinstallprompt', (e) => {
    console.log('[PWA] beforeinstallprompt event fired');
    e.preventDefault(); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–∞–Ω–Ω–µ—Ä
    deferredPrompt = e;

    // –°–æ–∑–¥–∞—ë–º –±–∞–Ω–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π
    const banner = document.createElement('div');
    banner.innerHTML = `
      <div style="
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #317EFB;
        color: white;
        padding: 14px 22px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        font-family: system-ui, sans-serif;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 2000;
      ">
        <span>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω?</span>
        <button id="install-btn" style="
          background: white;
          color: #317EFB;
          border: none;
          padding: 6px 14px;
          border-radius: 6px;
          font-weight: 600;
          cursor: pointer;
        ">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      </div>
    `;
    document.body.appendChild(banner);

    console.log('[PWA] Custom install banner shown');

    const installBtn = document.getElementById('install-btn');
    installBtn.addEventListener('click', async () => {
      console.log('[PWA] Install button clicked');
      banner.remove();

      deferredPrompt.prompt(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ –æ–∫–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
      const { outcome } = await deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        console.log('[PWA] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
      } else {
        console.log('[PWA] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏');
      }

      deferredPrompt = null;
    });
  });

  // –°–æ–±—ã—Ç–∏–µ, –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
  window.addEventListener('appinstalled', () => {
    console.log('[PWA] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
  });

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —É–∂–µ –ª–∏ –æ–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
  if (window.matchMedia('(display-mode: standalone)').matches) {
    console.log('[PWA] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –∫–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ');
  } else {
    console.log('[PWA] –ó–∞–ø—É—â–µ–Ω–æ –∫–∞–∫ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ)');
  }
</script>

  </body>
</html>
